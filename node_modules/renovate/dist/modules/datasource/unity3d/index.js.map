{"version":3,"file":"index.js","sourceRoot":"","sources":["../../../../lib/modules/datasource/unity3d/index.ts"],"names":[],"mappings":"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","sourcesContent":["import { XmlDocument, XmlElement } from 'xmldoc';\nimport { logger } from '../../../logger';\nimport { cache } from '../../../util/cache/package/decorator';\nimport * as Unity3dVersioning from '../../versioning/unity3d';\nimport { Datasource } from '../datasource';\nimport type { GetReleasesConfig, Release, ReleaseResult } from '../types';\n\nexport class Unity3dDatasource extends Datasource {\n  static readonly homepage = 'https://unity.com/';\n  static readonly streams: Record<string, string> = {\n    lts: `${Unity3dDatasource.homepage}releases/editor/lts-releases.xml`,\n    stable: `${Unity3dDatasource.homepage}releases/editor/releases.xml`,\n    beta: `${Unity3dDatasource.homepage}releases/editor/beta/latest.xml`,\n  };\n\n  static readonly id = 'unity3d';\n\n  override readonly defaultRegistryUrls = [\n    Unity3dDatasource.streams.stable,\n    Unity3dDatasource.streams.lts,\n  ];\n\n  override readonly defaultVersioning = Unity3dVersioning.id;\n\n  override readonly registryStrategy = 'merge';\n\n  override readonly releaseTimestampSupport = true;\n  override readonly releaseTimestampNote =\n    'The release timestamp is determined from the `pubDate` tag in the results.';\n\n  constructor() {\n    super(Unity3dDatasource.id);\n  }\n\n  async getByStream(\n    registryUrl: string | undefined,\n    withHash: boolean,\n  ): Promise<ReleaseResult | null> {\n    let channel: XmlElement | undefined = undefined;\n    try {\n      const response = await this.http.get(registryUrl!);\n      const document = new XmlDocument(response.body);\n      channel = document.childNamed('channel');\n    } catch (err) {\n      logger.error(\n        { err, registryUrl },\n        'Failed to request releases from Unity3d datasource',\n      );\n      return null;\n    }\n\n    if (!channel) {\n      return {\n        releases: [],\n        homepage: Unity3dDatasource.homepage,\n        registryUrl,\n      };\n    }\n    const releases = channel\n      .childrenNamed('item')\n      .map((itemNode) => {\n        const versionWithHash = `${itemNode.childNamed('title')?.val} (${itemNode.childNamed('guid')?.val})`;\n        const versionWithoutHash = itemNode.childNamed('title')?.val;\n        const release: Release = {\n          version: withHash ? versionWithHash : versionWithoutHash!,\n          releaseTimestamp: itemNode.childNamed('pubDate')?.val,\n          changelogUrl: itemNode.childNamed('link')?.val,\n          isStable: registryUrl !== Unity3dDatasource.streams.beta,\n          registryUrl,\n        };\n        return release;\n      })\n      .filter((release) => !!release);\n\n    return {\n      releases,\n      homepage: Unity3dDatasource.homepage,\n      registryUrl,\n    };\n  }\n\n  @cache({\n    namespace: `datasource-${Unity3dDatasource.id}`,\n    key: ({ registryUrl, packageName }: GetReleasesConfig) =>\n      `${registryUrl}:${packageName}`,\n  })\n  async getReleases({\n    packageName,\n    registryUrl,\n  }: GetReleasesConfig): Promise<ReleaseResult | null> {\n    return await this.getByStream(\n      registryUrl,\n      packageName === 'm_EditorVersionWithRevision',\n    );\n  }\n}\n"]}