{"version":3,"file":"index.js","sourceRoot":"","sources":["../../../../lib/modules/datasource/helm/index.ts"],"names":[],"mappings":"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","sourcesContent":["import is from '@sindresorhus/is';\nimport { logger } from '../../../logger';\nimport { cache } from '../../../util/cache/package/decorator';\nimport type { HttpResponse } from '../../../util/http/types';\nimport { ensureTrailingSlash } from '../../../util/url';\nimport { parseSingleYaml } from '../../../util/yaml';\nimport * as helmVersioning from '../../versioning/helm';\nimport { Datasource } from '../datasource';\nimport type { GetReleasesConfig, ReleaseResult } from '../types';\nimport { findSourceUrl } from './common';\nimport type { HelmRepository, HelmRepositoryData } from './types';\n\nexport class HelmDatasource extends Datasource {\n  static readonly id = 'helm';\n\n  constructor() {\n    super(HelmDatasource.id);\n  }\n\n  override readonly defaultRegistryUrls = ['https://charts.helm.sh/stable'];\n\n  override readonly defaultConfig = {\n    commitMessageTopic: 'Helm release {{depName}}',\n  };\n\n  override readonly defaultVersioning = helmVersioning.id;\n\n  override readonly releaseTimestampSupport = true;\n  override readonly releaseTimestampNote =\n    'The release timstamp is determined from the `created` field in the results.';\n  override readonly sourceUrlSupport = 'package';\n  override readonly sourceUrlNote =\n    'The source URL is determined from the `home` field or the `sources` field in the results.';\n\n  @cache({\n    namespace: `datasource-${HelmDatasource.id}`,\n    key: (helmRepository: string) => helmRepository,\n  })\n  async getRepositoryData(\n    helmRepository: string,\n  ): Promise<HelmRepositoryData | null> {\n    let res: HttpResponse<string>;\n    try {\n      res = await this.http.get('index.yaml', {\n        baseUrl: ensureTrailingSlash(helmRepository),\n      });\n      if (!res?.body) {\n        logger.warn(\n          { helmRepository },\n          `Received invalid response from helm repository`,\n        );\n        return null;\n      }\n    } catch (err) {\n      this.handleGenericErrors(err);\n    }\n    try {\n      // TODO: use schema (#9610)\n      const doc = parseSingleYaml<HelmRepository>(res.body, {\n        json: true,\n      });\n      if (!is.plainObject<HelmRepository>(doc)) {\n        logger.warn(\n          { helmRepository },\n          `Failed to parse index.yaml from helm repository`,\n        );\n        return null;\n      }\n      const result: HelmRepositoryData = {};\n      for (const [name, releases] of Object.entries(doc.entries)) {\n        if (releases.length === 0) {\n          continue;\n        }\n        const latestRelease = releases[0];\n        const sourceUrl = findSourceUrl(latestRelease);\n        result[name] = {\n          homepage: latestRelease.home,\n          sourceUrl,\n          releases: releases.map((release) => ({\n            version: release.version,\n            releaseTimestamp: release.created ?? null,\n            // The Helm repository at Gitlab does not include a digest (#24280)\n            newDigest: release.digest ?? undefined,\n          })),\n        };\n      }\n\n      return result;\n    } catch (err) {\n      logger.debug(\n        { helmRepository, err },\n        `Failed to parse index.yaml from helm repository`,\n      );\n      return null;\n    }\n  }\n\n  async getReleases({\n    packageName,\n    registryUrl: helmRepository,\n  }: GetReleasesConfig): Promise<ReleaseResult | null> {\n    // istanbul ignore if\n    if (!helmRepository) {\n      return null;\n    }\n\n    const repositoryData = await this.getRepositoryData(helmRepository);\n    if (!repositoryData) {\n      logger.debug(`Missing repo data from ${helmRepository}`);\n      return null;\n    }\n    const releases = repositoryData[packageName];\n    if (!releases) {\n      logger.debug(\n        { dependency: packageName },\n        `Entry ${packageName} doesn't exist in index.yaml from ${helmRepository}`,\n      );\n      return null;\n    }\n    return releases;\n  }\n}\n"]}