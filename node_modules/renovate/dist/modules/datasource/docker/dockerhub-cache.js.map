{"version":3,"file":"dockerhub-cache.js","sourceRoot":"","sources":["../../../../lib/modules/datasource/docker/dockerhub-cache.ts"],"names":[],"mappings":";;;;AAAA,mCAAgC;AAChC,iCAAiC;AACjC,kFAA4D;AAQ5D,MAAM,cAAc,GAAG,6BAA6B,CAAC;AAErD,MAAa,cAAc;IAIf;IACA;IAJF,SAAS,GAAG,KAAK,CAAC;IAE1B,YACU,gBAAwB,EACxB,KAAyB;QADzB,qBAAgB,GAAhB,gBAAgB,CAAQ;QACxB,UAAK,GAAL,KAAK,CAAoB;IAChC,CAAC;IAEJ,MAAM,CAAC,KAAK,CAAC,IAAI,CAAC,gBAAwB;QACxC,IAAI,SAAS,GAAG,MAAM,YAAY,CAAC,GAAG,CACpC,cAAc,EACd,gBAAgB,CACjB,CAAC;QAEF,SAAS,KAAK;YACZ,KAAK,EAAE,EAAE;YACT,SAAS,EAAE,IAAI;SAChB,CAAC;QAEF,OAAO,IAAI,cAAc,CAAC,gBAAgB,EAAE,SAAS,CAAC,CAAC;IACzD,CAAC;IAED,SAAS,CAAC,KAAqB;QAC7B,IAAI,YAAY,GAAG,IAAI,CAAC;QAExB,IAAI,EAAE,SAAS,EAAE,GAAG,IAAI,CAAC,KAAK,CAAC;QAC/B,IAAI,UAAU,GAAG,SAAS,CAAC,CAAC,CAAC,gBAAQ,CAAC,OAAO,CAAC,SAAS,CAAC,CAAC,CAAC,CAAC,IAAI,CAAC;QAEhE,KAAK,MAAM,OAAO,IAAI,KAAK,EAAE,CAAC;YAC5B,MAAM,EAAE,GAAG,OAAO,CAAC,EAAE,CAAC;YACtB,MAAM,OAAO,GAAG,IAAI,CAAC,KAAK,CAAC,KAAK,CAAC,EAAE,CAAC,CAAC;YAErC,IAAI,IAAA,eAAM,EAAC,OAAO,EAAE,OAAO,CAAC,EAAE,CAAC;gBAC7B,YAAY,GAAG,KAAK,CAAC;gBACrB,SAAS;YACX,CAAC;YAED,IAAI,CAAC,KAAK,CAAC,KAAK,CAAC,OAAO,CAAC,EAAE,CAAC,GAAG,OAAO,CAAC;YACvC,MAAM,WAAW,GAAG,gBAAQ,CAAC,OAAO,CAAC,OAAO,CAAC,YAAY,CAAC,CAAC;YAC3D,IAAI,CAAC,UAAU,IAAI,UAAU,GAAG,WAAW,EAAE,CAAC;gBAC5C,SAAS,GAAG,OAAO,CAAC,YAAY,CAAC;gBACjC,UAAU,GAAG,WAAW,CAAC;YAC3B,CAAC;YAED,IAAI,CAAC,SAAS,GAAG,IAAI,CAAC;QACxB,CAAC;QAED,IAAI,CAAC,KAAK,CAAC,SAAS,GAAG,SAAS,CAAC;QACjC,OAAO,YAAY,CAAC;IACtB,CAAC;IAED,KAAK,CAAC,IAAI;QACR,IAAI,IAAI,CAAC,SAAS,EAAE,CAAC;YACnB,MAAM,YAAY,CAAC,GAAG,CACpB,cAAc,EACd,IAAI,CAAC,gBAAgB,EACrB,IAAI,CAAC,KAAK,EACV,CAAC,GAAG,EAAE,GAAG,EAAE,GAAG,EAAE,CACjB,CAAC;QACJ,CAAC;IACH,CAAC;IAED,QAAQ;QACN,OAAO,MAAM,CAAC,MAAM,CAAC,IAAI,CAAC,KAAK,CAAC,KAAK,CAAC,CAAC;IACzC,CAAC;CACF;AAjED,wCAiEC","sourcesContent":["import { dequal } from 'dequal';\nimport { DateTime } from 'luxon';\nimport * as packageCache from '../../../util/cache/package';\nimport type { DockerHubTag } from './schema';\n\nexport interface DockerHubCacheData {\n  items: Record<number, DockerHubTag>;\n  updatedAt: string | null;\n}\n\nconst cacheNamespace = 'datasource-docker-hub-cache';\n\nexport class DockerHubCache {\n  private isChanged = false;\n\n  private constructor(\n    private dockerRepository: string,\n    private cache: DockerHubCacheData,\n  ) {}\n\n  static async init(dockerRepository: string): Promise<DockerHubCache> {\n    let repoCache = await packageCache.get<DockerHubCacheData>(\n      cacheNamespace,\n      dockerRepository,\n    );\n\n    repoCache ??= {\n      items: {},\n      updatedAt: null,\n    };\n\n    return new DockerHubCache(dockerRepository, repoCache);\n  }\n\n  reconcile(items: DockerHubTag[]): boolean {\n    let needNextPage = true;\n\n    let { updatedAt } = this.cache;\n    let latestDate = updatedAt ? DateTime.fromISO(updatedAt) : null;\n\n    for (const newItem of items) {\n      const id = newItem.id;\n      const oldItem = this.cache.items[id];\n\n      if (dequal(oldItem, newItem)) {\n        needNextPage = false;\n        continue;\n      }\n\n      this.cache.items[newItem.id] = newItem;\n      const newItemDate = DateTime.fromISO(newItem.last_updated);\n      if (!latestDate || latestDate < newItemDate) {\n        updatedAt = newItem.last_updated;\n        latestDate = newItemDate;\n      }\n\n      this.isChanged = true;\n    }\n\n    this.cache.updatedAt = updatedAt;\n    return needNextPage;\n  }\n\n  async save(): Promise<void> {\n    if (this.isChanged) {\n      await packageCache.set(\n        cacheNamespace,\n        this.dockerRepository,\n        this.cache,\n        3 * 60 * 24 * 30,\n      );\n    }\n  }\n\n  getItems(): DockerHubTag[] {\n    return Object.values(this.cache.items);\n  }\n}\n"]}