{"version":3,"file":"extract.js","sourceRoot":"","sources":["../../../../lib/modules/manager/flux/extract.ts"],"names":[],"mappings":";;;;AAAA,kEAAkC;AAClC,4CAAyC;AACzC,+CAAkD;AAClD,yCAAiD;AACjD,+CAA4C;AAC5C,6CAA+C;AAC/C,oEAA0E;AAC1E,oDAA2D;AAC3D,wDAA8D;AAC9D,wDAA8D;AAC9D,sEAA4E;AAC5E,8DAAoE;AACpE,8DAAoE;AACpE,gDAAuD;AACvD,mDAA+C;AAC/C,uCAA+D;AAC/D,kDAAoD;AAOpD,qCAAuE;AACvE,qCAA6D;AAQ7D,SAAS,YAAY,CACnB,OAAe,EACf,WAAmB;IAEnB,IAAI,IAAA,yBAAgB,EAAC,WAAW,CAAC,EAAE,CAAC;QAClC,MAAM,YAAY,GAAG,IAAA,aAAK,EAAC,kCAAyB,CAAC,CAAC,IAAI,CAAC,OAAO,CAAC,CAAC;QACpE,IAAI,CAAC,YAAY,EAAE,CAAC;YAClB,OAAO,IAAI,CAAC;QACd,CAAC;QACD,OAAO;YACL,IAAI,EAAE,QAAQ;YACd,IAAI,EAAE,WAAW;YACjB,OAAO,EAAE,YAAY,CAAC,CAAC,CAAC;YACxB,UAAU,EAAE,YAAY,CAAC,CAAC,CAAC;SAC5B,CAAC;IACJ,CAAC;IAED,IAAI,CAAC;QACH,MAAM,QAAQ,GAAiB;YAC7B,IAAI,EAAE,UAAU;YAChB,IAAI,EAAE,WAAW;YACjB,SAAS,EAAE,IAAA,gBAAS,EAAC,OAAO,EAAE,IAAI,EAAE;gBAClC,IAAI,EAAE,IAAI;gBACV,YAAY,EAAE,qBAAY;gBAC1B,gBAAgB,EAAE,QAAQ;aAC3B,CAAC;SACH,CAAC;QACF,OAAO,QAAQ,CAAC;IAClB,CAAC;IAAC,OAAO,GAAG,EAAE,CAAC;QACb,eAAM,CAAC,KAAK,CAAC,EAAE,GAAG,EAAE,WAAW,EAAE,EAAE,+BAA+B,CAAC,CAAC;QACpE,OAAO,IAAI,CAAC;IACd,CAAC;AACH,CAAC;AAED,MAAM,cAAc,GAAG,IAAA,aAAK,EAC1B,6EAA6E,CAC9E,CAAC;AACF,MAAM,cAAc,GAAG,IAAA,aAAK,EAC1B,6EAA6E,CAC9E,CAAC;AACF,MAAM,iBAAiB,GAAG,IAAA,aAAK,EAC7B,gFAAgF,CACjF,CAAC;AAEF,SAAS,gCAAgC,CACvC,GAAsB,EACtB,MAAc;IAEd,MAAM,iBAAiB,GAAG,cAAc,CAAC,IAAI,CAAC,MAAM,CAAC,EAAE,MAAM,CAAC;IAC9D,IAAI,iBAAiB,EAAE,CAAC;QACtB,GAAG,CAAC,UAAU,GAAG,kCAAoB,CAAC,EAAE,CAAC;QACzC,GAAG,CAAC,WAAW,GAAG,iBAAiB,CAAC,WAAW,CAAC;QAChD,GAAG,CAAC,SAAS,GAAG,sBAAsB,GAAG,CAAC,WAAW,EAAE,CAAC;QACxD,OAAO;IACT,CAAC;IAED,MAAM,iBAAiB,GAAG,cAAc,CAAC,IAAI,CAAC,MAAM,CAAC,EAAE,MAAM,CAAC;IAC9D,IAAI,iBAAiB,EAAE,CAAC;QACtB,GAAG,CAAC,UAAU,GAAG,kCAAoB,CAAC,EAAE,CAAC;QACzC,GAAG,CAAC,WAAW,GAAG,iBAAiB,CAAC,WAAW,CAAC;QAChD,GAAG,CAAC,SAAS,GAAG,sBAAsB,GAAG,CAAC,WAAW,EAAE,CAAC;QACxD,OAAO;IACT,CAAC;IAED,MAAM,oBAAoB,GAAG,iBAAiB,CAAC,IAAI,CAAC,MAAM,CAAC,EAAE,MAAM,CAAC;IACpE,IAAI,oBAAoB,EAAE,CAAC;QACzB,GAAG,CAAC,UAAU,GAAG,wCAAuB,CAAC,EAAE,CAAC;QAC5C,GAAG,CAAC,WAAW,GAAG,oBAAoB,CAAC,WAAW,CAAC;QACnD,GAAG,CAAC,SAAS,GAAG,yBAAyB,GAAG,CAAC,WAAW,EAAE,CAAC;QAC3D,OAAO;IACT,CAAC;IAED,GAAG,CAAC,UAAU,GAAG,4BAAiB,CAAC,EAAE,CAAC;IACtC,GAAG,CAAC,WAAW,GAAG,MAAM,CAAC;IACzB,IAAI,MAAM,CAAC,UAAU,CAAC,UAAU,CAAC,EAAE,CAAC;QAClC,GAAG,CAAC,SAAS,GAAG,MAAM,CAAC,OAAO,CAAC,QAAQ,EAAE,EAAE,CAAC,CAAC;IAC/C,CAAC;AACH,CAAC;AAED,SAAS,qBAAqB,CAC5B,QAA4B;IAE5B,OAAO;QACL;YACE,OAAO,EAAE,cAAc;YACvB,UAAU,EAAE,0CAAwB,CAAC,EAAE;YACvC,YAAY,EAAE,QAAQ,CAAC,OAAO;YAC9B,WAAW,EAAE;gBACX,UAAU,EAAE,QAAQ,CAAC,UAAU;aAChC;SACF;KACF,CAAC;AACJ,CAAC;AAED,SAAS,uBAAuB,CAC9B,QAA8B,EAC9B,gBAAkC,EAClC,eAAmD;IAEnD,MAAM,IAAI,GAAwB,EAAE,CAAC;IACrC,KAAK,MAAM,QAAQ,IAAI,QAAQ,CAAC,SAAS,EAAE,CAAC;QAC1C,QAAQ,QAAQ,CAAC,IAAI,EAAE,CAAC;YACtB,KAAK,aAAa,CAAC,CAAC,CAAC;gBACnB,MAAM,GAAG,GAAsB;oBAC7B,OAAO,EAAE,QAAQ,CAAC,IAAI,CAAC,KAAK,CAAC,IAAI,CAAC,KAAK;oBACvC,YAAY,EAAE,QAAQ,CAAC,IAAI,CAAC,KAAK,CAAC,IAAI,CAAC,OAAO;oBAC9C,UAAU,EAAE,qBAAc,CAAC,EAAE;iBAC9B,CAAC;gBAEF,MAAM,oBAAoB,GAAG,gBAAgB,CAAC,MAAM,CAClD,CAAC,GAAG,EAAE,EAAE,CACN,GAAG,CAAC,IAAI,KAAK,QAAQ,CAAC,IAAI,CAAC,KAAK,CAAC,IAAI,CAAC,SAAS,EAAE,IAAI;oBACrD,GAAG,CAAC,QAAQ,CAAC,IAAI,KAAK,QAAQ,CAAC,IAAI,CAAC,KAAK,CAAC,IAAI,CAAC,SAAS,CAAC,IAAI;oBAC7D,GAAG,CAAC,QAAQ,CAAC,SAAS;wBACpB,CAAC,QAAQ,CAAC,IAAI,CAAC,KAAK,CAAC,IAAI,CAAC,SAAS,CAAC,SAAS;4BAC3C,QAAQ,CAAC,QAAQ,EAAE,SAAS,CAAC,CACpC,CAAC;gBACF,IAAI,oBAAoB,CAAC,MAAM,EAAE,CAAC;oBAChC,GAAG,CAAC,YAAY,GAAG,oBAAoB;yBACpC,GAAG,CAAC,CAAC,IAAI,EAAE,EAAE;wBACZ,IAAI,IAAI,CAAC,IAAI,CAAC,IAAI,KAAK,KAAK,IAAI,IAAA,mBAAa,EAAC,IAAI,CAAC,IAAI,CAAC,GAAG,CAAC,EAAE,CAAC;4BAC7D,8BAA8B;4BAC9B,GAAG,CAAC,UAAU,GAAG,yBAAgB,CAAC,EAAE,CAAC;4BACrC,qCAAqC;4BACrC,GAAG,CAAC,WAAW,GAAG,IAAA,gBAAM,EACtB,GAAG,IAAA,qBAAe,EAAC,IAAI,CAAC,IAAI,CAAC,GAAG,CAAC,IAC/B,QAAQ,CAAC,IAAI,CAAC,KAAK,CAAC,IAAI,CAAC,KAC3B,EAAE,EACF,KAAK,EACL,eAAe,CAChB,CAAC,OAAO,CAAC;4BACV,OAAO,IAAI,CAAC;wBACd,CAAC;6BAAM,CAAC;4BACN,OAAO,IAAI,CAAC,IAAI,CAAC,GAAG,CAAC;wBACvB,CAAC;oBACH,CAAC,CAAC;yBACD,MAAM,CAAC,YAAE,CAAC,MAAM,CAAC,CAAC;oBAErB,+CAA+C;oBAC/C,IAAI,CAAC,GAAG,CAAC,YAAY,EAAE,MAAM,EAAE,CAAC;wBAC9B,OAAO,GAAG,CAAC,YAAY,CAAC;oBAC1B,CAAC;gBACH,CAAC;qBAAM,CAAC;oBACN,GAAG,CAAC,UAAU,GAAG,kBAAkB,CAAC;gBACtC,CAAC;gBACD,IAAI,CAAC,IAAI,CAAC,GAAG,CAAC,CAAC;gBACf,MAAM;YACR,CAAC;YACD,KAAK,eAAe,CAAC,CAAC,CAAC;gBACrB,MAAM,GAAG,GAAsB;oBAC7B,OAAO,EAAE,QAAQ,CAAC,QAAQ,CAAC,IAAI;iBAChC,CAAC;gBAEF,IAAI,QAAQ,CAAC,IAAI,CAAC,GAAG,EAAE,MAAM,EAAE,CAAC;oBAC9B,MAAM,MAAM,GAAG,QAAQ,CAAC,IAAI,CAAC,GAAG,CAAC;oBACjC,GAAG,CAAC,aAAa,GAAG,QAAQ,CAAC,IAAI,CAAC,GAAG,CAAC,MAAM,CAAC;oBAC7C,GAAG,CAAC,UAAU,GAAG,4BAAiB,CAAC,EAAE,CAAC;oBACtC,GAAG,CAAC,WAAW,GAAG,MAAM,CAAC;oBACzB,GAAG,CAAC,aAAa,GAAG,QAAQ,CAAC,IAAI,CAAC,GAAG,CAAC,MAAM,CAAC;oBAC7C,IAAI,MAAM,CAAC,UAAU,CAAC,UAAU,CAAC,EAAE,CAAC;wBAClC,GAAG,CAAC,SAAS,GAAG,MAAM,CAAC,OAAO,CAAC,QAAQ,EAAE,EAAE,CAAC,CAAC;oBAC/C,CAAC;gBACH,CAAC;qBAAM,IAAI,QAAQ,CAAC,IAAI,CAAC,GAAG,EAAE,GAAG,EAAE,CAAC;oBAClC,GAAG,CAAC,YAAY,GAAG,QAAQ,CAAC,IAAI,CAAC,GAAG,CAAC,GAAG,CAAC;oBACzC,gCAAgC,CAAC,GAAG,EAAE,QAAQ,CAAC,IAAI,CAAC,GAAG,CAAC,CAAC;gBAC3D,CAAC;qBAAM,CAAC;oBACN,GAAG,CAAC,UAAU,GAAG,uBAAuB,CAAC;gBAC3C,CAAC;gBACD,IAAI,CAAC,IAAI,CAAC,GAAG,CAAC,CAAC;gBACf,MAAM;YACR,CAAC;YACD,KAAK,eAAe,CAAC,CAAC,CAAC;gBACrB,MAAM,SAAS,GAAG,IAAA,qBAAe,EAAC,QAAQ,CAAC,IAAI,CAAC,GAAG,CAAC,CAAC;gBACrD,IAAI,GAAG,GAAG,IAAA,gBAAM,EAAC,SAAS,EAAE,KAAK,EAAE,eAAe,CAAC,CAAC;gBACpD,IAAI,QAAQ,CAAC,IAAI,CAAC,GAAG,EAAE,MAAM,EAAE,CAAC;oBAC9B,GAAG,GAAG,IAAA,gBAAM,EACV,GAAG,SAAS,IAAI,QAAQ,CAAC,IAAI,CAAC,GAAG,CAAC,MAAM,EAAE,EAC1C,KAAK,EACL,eAAe,CAChB,CAAC;oBACF,IAAI,QAAQ,CAAC,IAAI,CAAC,GAAG,EAAE,GAAG,EAAE,CAAC;wBAC3B,eAAM,CAAC,KAAK,CAAC,0CAA0C,CAAC,CAAC;oBAC3D,CAAC;gBACH,CAAC;qBAAM,IAAI,QAAQ,CAAC,IAAI,CAAC,GAAG,EAAE,GAAG,EAAE,CAAC;oBAClC,GAAG,GAAG,IAAA,gBAAM,EACV,GAAG,SAAS,IAAI,QAAQ,CAAC,IAAI,CAAC,GAAG,CAAC,GAAG,EAAE,EACvC,KAAK,EACL,eAAe,CAChB,CAAC;oBACF,GAAG,CAAC,yBAAyB;wBAC3B,2EAA2E,CAAC;oBAC9E,GAAG,CAAC,aAAa,GAAG,QAAQ,CAAC,IAAI,CAAC,GAAG,CAAC,GAAG,CAAC;gBAC5C,CAAC;qBAAM,CAAC;oBACN,GAAG,CAAC,UAAU,GAAG,uBAAuB,CAAC;gBAC3C,CAAC;gBACD,IAAI,CAAC,IAAI,CAAC,GAAG,CAAC,CAAC;gBACf,MAAM;YACR,CAAC;YAED,KAAK,eAAe,CAAC,CAAC,CAAC;gBACrB,KAAK,MAAM,KAAK,IAAI,IAAA,mBAAW,EAAC,QAAQ,CAAC,IAAI,CAAC,MAAM,CAAC,EAAE,CAAC;oBACtD,MAAM,GAAG,GAAG,IAAA,sBAAY,EAAC,KAAK,EAAE,eAAe,CAAC,CAAC;oBACjD,IAAI,GAAG,EAAE,CAAC;wBACR,IAAI,CAAC,IAAI,CAAC,GAAG,CAAC,CAAC;oBACjB,CAAC;gBACH,CAAC;YACH,CAAC;QACH,CAAC;IACH,CAAC;IACD,OAAO,IAAI,CAAC;AACd,CAAC;AAED,SAAgB,kBAAkB,CAChC,OAAe,EACf,WAAmB,EACnB,MAAsB;IAEtB,MAAM,QAAQ,GAAG,YAAY,CAAC,OAAO,EAAE,WAAW,CAAC,CAAC;IACpD,IAAI,CAAC,QAAQ,EAAE,CAAC;QACd,OAAO,IAAI,CAAC;IACd,CAAC;IACD,MAAM,gBAAgB,GAAqB,EAAE,CAAC;IAC9C,IAAI,QAAQ,CAAC,IAAI,KAAK,UAAU,EAAE,CAAC;QACjC,KAAK,MAAM,QAAQ,IAAI,QAAQ,CAAC,SAAS,EAAE,CAAC;YAC1C,IAAI,QAAQ,CAAC,IAAI,KAAK,gBAAgB,EAAE,CAAC;gBACvC,gBAAgB,CAAC,IAAI,CAAC,QAAQ,CAAC,CAAC;YAClC,CAAC;QACH,CAAC;IACH,CAAC;IACD,IAAI,IAAI,GAA+B,IAAI,CAAC;IAC5C,QAAQ,QAAQ,CAAC,IAAI,EAAE,CAAC;QACtB,KAAK,QAAQ;YACX,IAAI,GAAG,qBAAqB,CAAC,QAAQ,CAAC,CAAC;YACvC,MAAM;QACR,KAAK,UAAU,CAAC,CAAC,CAAC;YAChB,IAAI,GAAG,uBAAuB,CAC5B,QAAQ,EACR,gBAAgB,EAChB,MAAM,EAAE,eAAe,CACxB,CAAC;YACF,MAAM;QACR,CAAC;IACH,CAAC;IACD,OAAO,IAAI,EAAE,MAAM,CAAC,CAAC,CAAC,EAAE,IAAI,EAAE,CAAC,CAAC,CAAC,IAAI,CAAC;AACxC,CAAC;AAhCD,gDAgCC;AAEM,KAAK,UAAU,sBAAsB,CAC1C,MAAqB,EACrB,YAAsB;IAEtB,MAAM,SAAS,GAAmB,EAAE,CAAC;IACrC,MAAM,OAAO,GAAmC,EAAE,CAAC;IAEnD,KAAK,MAAM,IAAI,IAAI,YAAY,EAAE,CAAC;QAChC,MAAM,OAAO,GAAG,MAAM,IAAA,kBAAa,EAAC,IAAI,EAAE,MAAM,CAAC,CAAC;QAClD,cAAc;QACd,MAAM,QAAQ,GAAG,YAAY,CAAC,OAAQ,EAAE,IAAI,CAAC,CAAC;QAC9C,IAAI,QAAQ,EAAE,CAAC;YACb,SAAS,CAAC,IAAI,CAAC,QAAQ,CAAC,CAAC;QAC3B,CAAC;IACH,CAAC;IAED,MAAM,gBAAgB,GAAqB,EAAE,CAAC;IAC9C,KAAK,MAAM,QAAQ,IAAI,SAAS,EAAE,CAAC;QACjC,IAAI,QAAQ,CAAC,IAAI,KAAK,UAAU,EAAE,CAAC;YACjC,KAAK,MAAM,QAAQ,IAAI,QAAQ,CAAC,SAAS,EAAE,CAAC;gBAC1C,IAAI,QAAQ,CAAC,IAAI,KAAK,gBAAgB,EAAE,CAAC;oBACvC,gBAAgB,CAAC,IAAI,CAAC,QAAQ,CAAC,CAAC;gBAClC,CAAC;YACH,CAAC;QACH,CAAC;IACH,CAAC;IAED,KAAK,MAAM,QAAQ,IAAI,SAAS,EAAE,CAAC;QACjC,IAAI,IAAI,GAA+B,IAAI,CAAC;QAC5C,QAAQ,QAAQ,CAAC,IAAI,EAAE,CAAC;YACtB,KAAK,QAAQ;gBACX,IAAI,GAAG,qBAAqB,CAAC,QAAQ,CAAC,CAAC;gBACvC,MAAM;YACR,KAAK,UAAU,CAAC,CAAC,CAAC;gBAChB,IAAI,GAAG,uBAAuB,CAC5B,QAAQ,EACR,gBAAgB,EAChB,MAAM,CAAC,eAAe,CACvB,CAAC;gBACF,MAAM;YACR,CAAC;QACH,CAAC;QACD,IAAI,IAAI,EAAE,MAAM,EAAE,CAAC;YACjB,OAAO,CAAC,IAAI,CAAC;gBACX,WAAW,EAAE,QAAQ,CAAC,IAAI;gBAC1B,IAAI;aACL,CAAC,CAAC;QACL,CAAC;IACH,CAAC;IAED,OAAO,OAAO,CAAC,MAAM,CAAC,CAAC,CAAC,OAAO,CAAC,CAAC,CAAC,IAAI,CAAC;AACzC,CAAC;AAnDD,wDAmDC","sourcesContent":["import is from '@sindresorhus/is';\nimport { logger } from '../../../logger';\nimport { coerceArray } from '../../../util/array';\nimport { readLocalFile } from '../../../util/fs';\nimport { regEx } from '../../../util/regex';\nimport { parseYaml } from '../../../util/yaml';\nimport { BitbucketTagsDatasource } from '../../datasource/bitbucket-tags';\nimport { DockerDatasource } from '../../datasource/docker';\nimport { GitRefsDatasource } from '../../datasource/git-refs';\nimport { GitTagsDatasource } from '../../datasource/git-tags';\nimport { GithubReleasesDatasource } from '../../datasource/github-releases';\nimport { GithubTagsDatasource } from '../../datasource/github-tags';\nimport { GitlabTagsDatasource } from '../../datasource/gitlab-tags';\nimport { HelmDatasource } from '../../datasource/helm';\nimport { getDep } from '../dockerfile/extract';\nimport { isOCIRegistry, removeOCIPrefix } from '../helmv3/oci';\nimport { extractImage } from '../kustomize/extract';\nimport type {\n  ExtractConfig,\n  PackageDependency,\n  PackageFile,\n  PackageFileContent,\n} from '../types';\nimport { isSystemManifest, systemManifestHeaderRegex } from './common';\nimport { FluxResource, type HelmRepository } from './schema';\nimport type {\n  FluxManagerData,\n  FluxManifest,\n  ResourceFluxManifest,\n  SystemFluxManifest,\n} from './types';\n\nfunction readManifest(\n  content: string,\n  packageFile: string,\n): FluxManifest | null {\n  if (isSystemManifest(packageFile)) {\n    const versionMatch = regEx(systemManifestHeaderRegex).exec(content);\n    if (!versionMatch) {\n      return null;\n    }\n    return {\n      kind: 'system',\n      file: packageFile,\n      version: versionMatch[1],\n      components: versionMatch[2],\n    };\n  }\n\n  try {\n    const manifest: FluxManifest = {\n      kind: 'resource',\n      file: packageFile,\n      resources: parseYaml(content, null, {\n        json: true,\n        customSchema: FluxResource,\n        failureBehaviour: 'filter',\n      }),\n    };\n    return manifest;\n  } catch (err) {\n    logger.debug({ err, packageFile }, 'Failed to parse Flux manifest');\n    return null;\n  }\n}\n\nconst githubUrlRegex = regEx(\n  /^(?:https:\\/\\/|git@)github\\.com[/:](?<packageName>[^/]+\\/[^/]+?)(?:\\.git)?$/,\n);\nconst gitlabUrlRegex = regEx(\n  /^(?:https:\\/\\/|git@)gitlab\\.com[/:](?<packageName>[^/]+\\/[^/]+?)(?:\\.git)?$/,\n);\nconst bitbucketUrlRegex = regEx(\n  /^(?:https:\\/\\/|git@)bitbucket\\.org[/:](?<packageName>[^/]+\\/[^/]+?)(?:\\.git)?$/,\n);\n\nfunction resolveGitRepositoryPerSourceTag(\n  dep: PackageDependency,\n  gitUrl: string,\n): void {\n  const githubMatchGroups = githubUrlRegex.exec(gitUrl)?.groups;\n  if (githubMatchGroups) {\n    dep.datasource = GithubTagsDatasource.id;\n    dep.packageName = githubMatchGroups.packageName;\n    dep.sourceUrl = `https://github.com/${dep.packageName}`;\n    return;\n  }\n\n  const gitlabMatchGroups = gitlabUrlRegex.exec(gitUrl)?.groups;\n  if (gitlabMatchGroups) {\n    dep.datasource = GitlabTagsDatasource.id;\n    dep.packageName = gitlabMatchGroups.packageName;\n    dep.sourceUrl = `https://gitlab.com/${dep.packageName}`;\n    return;\n  }\n\n  const bitbucketMatchGroups = bitbucketUrlRegex.exec(gitUrl)?.groups;\n  if (bitbucketMatchGroups) {\n    dep.datasource = BitbucketTagsDatasource.id;\n    dep.packageName = bitbucketMatchGroups.packageName;\n    dep.sourceUrl = `https://bitbucket.org/${dep.packageName}`;\n    return;\n  }\n\n  dep.datasource = GitTagsDatasource.id;\n  dep.packageName = gitUrl;\n  if (gitUrl.startsWith('https://')) {\n    dep.sourceUrl = gitUrl.replace(/\\.git$/, '');\n  }\n}\n\nfunction resolveSystemManifest(\n  manifest: SystemFluxManifest,\n): PackageDependency<FluxManagerData>[] {\n  return [\n    {\n      depName: 'fluxcd/flux2',\n      datasource: GithubReleasesDatasource.id,\n      currentValue: manifest.version,\n      managerData: {\n        components: manifest.components,\n      },\n    },\n  ];\n}\n\nfunction resolveResourceManifest(\n  manifest: ResourceFluxManifest,\n  helmRepositories: HelmRepository[],\n  registryAliases: Record<string, string> | undefined,\n): PackageDependency[] {\n  const deps: PackageDependency[] = [];\n  for (const resource of manifest.resources) {\n    switch (resource.kind) {\n      case 'HelmRelease': {\n        const dep: PackageDependency = {\n          depName: resource.spec.chart.spec.chart,\n          currentValue: resource.spec.chart.spec.version,\n          datasource: HelmDatasource.id,\n        };\n\n        const matchingRepositories = helmRepositories.filter(\n          (rep) =>\n            rep.kind === resource.spec.chart.spec.sourceRef?.kind &&\n            rep.metadata.name === resource.spec.chart.spec.sourceRef.name &&\n            rep.metadata.namespace ===\n              (resource.spec.chart.spec.sourceRef.namespace ??\n                resource.metadata?.namespace),\n        );\n        if (matchingRepositories.length) {\n          dep.registryUrls = matchingRepositories\n            .map((repo) => {\n              if (repo.spec.type === 'oci' || isOCIRegistry(repo.spec.url)) {\n                // Change datasource to Docker\n                dep.datasource = DockerDatasource.id;\n                // Ensure the URL is a valid OCI path\n                dep.packageName = getDep(\n                  `${removeOCIPrefix(repo.spec.url)}/${\n                    resource.spec.chart.spec.chart\n                  }`,\n                  false,\n                  registryAliases,\n                ).depName;\n                return null;\n              } else {\n                return repo.spec.url;\n              }\n            })\n            .filter(is.string);\n\n          // if registryUrls is empty, delete it from dep\n          if (!dep.registryUrls?.length) {\n            delete dep.registryUrls;\n          }\n        } else {\n          dep.skipReason = 'unknown-registry';\n        }\n        deps.push(dep);\n        break;\n      }\n      case 'GitRepository': {\n        const dep: PackageDependency = {\n          depName: resource.metadata.name,\n        };\n\n        if (resource.spec.ref?.commit) {\n          const gitUrl = resource.spec.url;\n          dep.currentDigest = resource.spec.ref.commit;\n          dep.datasource = GitRefsDatasource.id;\n          dep.packageName = gitUrl;\n          dep.replaceString = resource.spec.ref.commit;\n          if (gitUrl.startsWith('https://')) {\n            dep.sourceUrl = gitUrl.replace(/\\.git$/, '');\n          }\n        } else if (resource.spec.ref?.tag) {\n          dep.currentValue = resource.spec.ref.tag;\n          resolveGitRepositoryPerSourceTag(dep, resource.spec.url);\n        } else {\n          dep.skipReason = 'unversioned-reference';\n        }\n        deps.push(dep);\n        break;\n      }\n      case 'OCIRepository': {\n        const container = removeOCIPrefix(resource.spec.url);\n        let dep = getDep(container, false, registryAliases);\n        if (resource.spec.ref?.digest) {\n          dep = getDep(\n            `${container}@${resource.spec.ref.digest}`,\n            false,\n            registryAliases,\n          );\n          if (resource.spec.ref?.tag) {\n            logger.debug('A digest and tag was found, ignoring tag');\n          }\n        } else if (resource.spec.ref?.tag) {\n          dep = getDep(\n            `${container}:${resource.spec.ref.tag}`,\n            false,\n            registryAliases,\n          );\n          dep.autoReplaceStringTemplate =\n            '{{#if newValue}}{{newValue}}{{/if}}{{#if newDigest}}@{{newDigest}}{{/if}}';\n          dep.replaceString = resource.spec.ref.tag;\n        } else {\n          dep.skipReason = 'unversioned-reference';\n        }\n        deps.push(dep);\n        break;\n      }\n\n      case 'Kustomization': {\n        for (const image of coerceArray(resource.spec.images)) {\n          const dep = extractImage(image, registryAliases);\n          if (dep) {\n            deps.push(dep);\n          }\n        }\n      }\n    }\n  }\n  return deps;\n}\n\nexport function extractPackageFile(\n  content: string,\n  packageFile: string,\n  config?: ExtractConfig,\n): PackageFileContent<FluxManagerData> | null {\n  const manifest = readManifest(content, packageFile);\n  if (!manifest) {\n    return null;\n  }\n  const helmRepositories: HelmRepository[] = [];\n  if (manifest.kind === 'resource') {\n    for (const resource of manifest.resources) {\n      if (resource.kind === 'HelmRepository') {\n        helmRepositories.push(resource);\n      }\n    }\n  }\n  let deps: PackageDependency[] | null = null;\n  switch (manifest.kind) {\n    case 'system':\n      deps = resolveSystemManifest(manifest);\n      break;\n    case 'resource': {\n      deps = resolveResourceManifest(\n        manifest,\n        helmRepositories,\n        config?.registryAliases,\n      );\n      break;\n    }\n  }\n  return deps?.length ? { deps } : null;\n}\n\nexport async function extractAllPackageFiles(\n  config: ExtractConfig,\n  packageFiles: string[],\n): Promise<PackageFile<FluxManagerData>[] | null> {\n  const manifests: FluxManifest[] = [];\n  const results: PackageFile<FluxManagerData>[] = [];\n\n  for (const file of packageFiles) {\n    const content = await readLocalFile(file, 'utf8');\n    // TODO #22198\n    const manifest = readManifest(content!, file);\n    if (manifest) {\n      manifests.push(manifest);\n    }\n  }\n\n  const helmRepositories: HelmRepository[] = [];\n  for (const manifest of manifests) {\n    if (manifest.kind === 'resource') {\n      for (const resource of manifest.resources) {\n        if (resource.kind === 'HelmRepository') {\n          helmRepositories.push(resource);\n        }\n      }\n    }\n  }\n\n  for (const manifest of manifests) {\n    let deps: PackageDependency[] | null = null;\n    switch (manifest.kind) {\n      case 'system':\n        deps = resolveSystemManifest(manifest);\n        break;\n      case 'resource': {\n        deps = resolveResourceManifest(\n          manifest,\n          helmRepositories,\n          config.registryAliases,\n        );\n        break;\n      }\n    }\n    if (deps?.length) {\n      results.push({\n        packageFile: manifest.file,\n        deps,\n      });\n    }\n  }\n\n  return results.length ? results : null;\n}\n"]}