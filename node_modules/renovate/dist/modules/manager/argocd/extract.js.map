{"version":3,"file":"extract.js","sourceRoot":"","sources":["../../../../lib/modules/manager/argocd/extract.ts"],"names":[],"mappings":"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","sourcesContent":["import is from '@sindresorhus/is';\nimport { logger } from '../../../logger';\nimport { coerceArray } from '../../../util/array';\nimport { trimTrailingSlash } from '../../../util/url';\nimport { parseYaml } from '../../../util/yaml';\nimport { DockerDatasource } from '../../datasource/docker';\nimport { GitTagsDatasource } from '../../datasource/git-tags';\nimport { HelmDatasource } from '../../datasource/helm';\nimport { isOCIRegistry, removeOCIPrefix } from '../helmv3/oci';\nimport type {\n  ExtractConfig,\n  PackageDependency,\n  PackageFileContent,\n} from '../types';\nimport {\n  ApplicationDefinition,\n  type ApplicationSource,\n  type ApplicationSpec,\n} from './schema';\nimport { fileTestRegex } from './util';\n\nexport function extractPackageFile(\n  content: string,\n  packageFile: string,\n  _config?: ExtractConfig,\n): PackageFileContent | null {\n  // check for argo reference. API version for the kind attribute is used\n  if (fileTestRegex.test(content) === false) {\n    logger.debug(\n      `Skip file ${packageFile} as no argoproj.io apiVersion could be found in matched file`,\n    );\n    return null;\n  }\n\n  let definitions: ApplicationDefinition[];\n  try {\n    definitions = parseYaml(content, null, {\n      customSchema: ApplicationDefinition,\n      failureBehaviour: 'filter',\n      removeTemplates: true,\n    });\n  } catch (err) {\n    logger.debug({ err, packageFile }, 'Failed to parse ArgoCD definition.');\n    return null;\n  }\n\n  const deps = definitions.flatMap(processAppSpec);\n\n  return deps.length ? { deps } : null;\n}\n\nfunction processSource(source: ApplicationSource): PackageDependency | null {\n  // a chart variable is defined this is helm declaration\n  if (source.chart) {\n    // assume OCI helm chart if repoURL doesn't contain explicit protocol\n    if (isOCIRegistry(source.repoURL) || !source.repoURL.includes('://')) {\n      const registryURL = trimTrailingSlash(removeOCIPrefix(source.repoURL));\n\n      return {\n        depName: `${registryURL}/${source.chart}`,\n        currentValue: source.targetRevision,\n        datasource: DockerDatasource.id,\n      };\n    }\n\n    return {\n      depName: source.chart,\n      registryUrls: [source.repoURL],\n      currentValue: source.targetRevision,\n      datasource: HelmDatasource.id,\n    };\n  }\n\n  return {\n    depName: source.repoURL,\n    currentValue: source.targetRevision,\n    datasource: GitTagsDatasource.id,\n  };\n}\n\nfunction processAppSpec(\n  definition: ApplicationDefinition,\n): PackageDependency[] {\n  const spec: ApplicationSpec =\n    definition.kind === 'Application'\n      ? definition.spec\n      : definition.spec.template.spec;\n\n  const deps: (PackageDependency | null)[] = [];\n\n  if (is.nonEmptyObject(spec.source)) {\n    deps.push(processSource(spec.source));\n  }\n\n  for (const source of coerceArray(spec.sources)) {\n    deps.push(processSource(source));\n  }\n\n  return deps.filter(is.truthy);\n}\n"]}